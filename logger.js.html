<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: logger.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: logger.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Utility module for creating loggers with a globally equal, customised format.
 * @module
 */

'use strict'

const cls = require('cls-hooked')
const uuid = require('uuid/v4')
const path = require('path')
const winston = require('winston')

const correlationStore = cls.createNamespace('b7278b8c-fd1f-4875-b63e-550b3ca34696')

/**
 * Create a logger for the given module. Prints JSON messages to the console,
 * adding information like the logging module's filename, a timestamp and a
 * correlation id if called from within {@link module:logger.correlate}.
 *
 * @example
 * const log = require('./logger').logger(__filename)
 * log.info('Hello, world')
 * // Output (indented for better readability):
 * // {
 * //   "message": "Hello, world",
 * //   "level": "info",
 * //   "filename": "test.js",
 * //   "timestamp":"2018-08-12T17:08:45.339Z"
 * // }
 *
 * @param  {string} filename The filename to use then logging messages. Only the
 * basename will be logged.
 * @return {winston.Logger} The pre-configured logger.
 */
module.exports.createLogger = function createLogger (filename) {
  const logger = winston.createLogger({
    level: process.env.DEBUG ? 'silly' : 'verbose',
    format: winston.format.combine(
      // Add correlation id if available
      winston.format((info, opts) => {
        const correlationId = correlationStore.get('correlationId')
        if (correlationId) return Object.assign(info, { correlationId })
        return info
      })(),
      winston.format(info => Object.assign(info, { filename: path.basename(filename) }))(),
      winston.format.timestamp(),
      winston.format.json()
    ),
    transports: [new winston.transports.Console()]
  })

  return logger
}

/**
 * Call the given function and add a correlation id to all messages logged
 * during the function's execution unique to this correlate() call when using a
 * logger created through {@link module:logger.createLogger}.
 *
 * @example
 * const logger = require('./logger')
 * const log = logger.createLogger(__filename)
 * logger.correlate(() => {
 *   log.info('Test 1')
 *   setTimeout(() => { log.info('Test 2') }, 1000)
 * })
 * log.info('Test 3')
 * // Output (indented for better readability):
 * // {
 * //   "message": "Test 1",
 * //   "level": "info",
 * //   "correlationId": "957b17ec-13f5-4e1e-9683-7a6fc8198f1c",
 * //   "filename": "test.js",
 * //   "timestamp": "2018-08-12T19:27:09.381Z"
 * // }
 * // {
 * //   "message": "Test 3",
 * //   "level": "info",
 * //   "filename": "test.js",
 * //   "timestamp": "2018-08-12T19:27:09.385Z"
 * // }
 * // ...after 1 second:
 * // {
 * //   "message": "Test 3",
 * //   "level": "info",
 * //   "correlationId": "957b17ec-13f5-4e1e-9683-7a6fc8198f1c",
 * //   "filename": "test.js",
 * //   "timestamp": "2018-08-12T19:27:10.386Z"
 * // }
 *
 * @param  {Function} fn The function to call.
 * @return {Any} Return value of the given function, if any.
 */
module.exports.correlate = function correlate (fn) {
  return correlationStore.runAndReturn(() => {
    correlationStore.set('correlationId', uuid())
    return fn()
  })
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-logger.html">logger</a></li><li><a href="module-mqtt-wrapper.html">mqtt-wrapper</a></li><li><a href="module-schemas_schema-validator.html">schemas/schema-validator</a></li><li><a href="module-turtle.html">turtle</a></li><li><a href="module-turtle-manager.html">turtle-manager</a></li></ul><h3>Externals</h3><ul><li><a href="external-_jsonschema.Validator_.html">jsonschema.Validator</a></li></ul><h3>Classes</h3><ul><li><a href="module-mqtt-wrapper-MQTTWrapper.html">MQTTWrapper</a></li><li><a href="module-turtle-manager-TurtleManager.html">TurtleManager</a></li><li><a href="module-turtle-Turtle.html">Turtle</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
